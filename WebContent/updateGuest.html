<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Update Guest</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> 
        <!--Font Awesome (added because you use icons in your prepend/append)-->
        <link rel="stylesheet" href="https://formden.com/static/cdn/font-awesome/4.4.0/css/font-awesome.min.css" />
 	 	<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
 	 	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
 	 	<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
  		<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script>
	function confirmLogout(){
	    agree = confirm("Do you want to logout?");
	     if(agree){
	 		window.location.assign("Logout.html");
	 	}
	}
	
	$.urlParam = function(name){
	    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
	    if (results==null){
	       return null;
	    }
	    else{
	       return results[1] || 0;
	    }
	}
	
	function backToGuestList(){
		window.location.assign("guestList.html?id="+$.urlParam("event")+"&like=like");
	}
	// Generates the table marker for the guest.
	// The generate table marker button must have an onclick that references this function
	function generateTableMarker() {
	    var req = new XMLHttpRequest();
		 req.open("GET", "/eventplannerJava/eventplanner/reportservice/tablemarkers/"+$.urlParam("id"), true);
		 req.responseType = "blob";
		 req.onload = function (event) {
			 var blob = req.response;
			 console.log(blob.size);
			 var link = document.createElement('a');
			 link.href = window.URL.createObjectURL(blob);
			 link.download = "TableMarker_" + new Date() + ".pdf";
			 link.click();
		 };
		 req.send();
	}

$(document).ready(function() {

	$("#guestselection").select2({
	 	  ajax:{
	            url: "/eventplannerJava/eventplanner/guestservice/guestsbyguestlist/"+$.urlParam("event"),
	            dataType: 'json',
	            contentType: 'application/json',
	            type: 'GET',
	            cache:false,
	            processResults: function (data) {
	                return {
	                    results: $.map(data, function(obj) {
	                        return { id: obj.id, text:obj.name};
	                    })
	                };
	            }
	        }
	 	});
	$("#guestsToSitWith").select2({
	 	  ajax:{
	            url: "/eventplannerJava/eventplanner/guestservice/guests/"+$.urlParam("id")+"/gueststositwith",
	            dataType: 'json',
	            type: 'GET',
	            cache:false,
	            processResults: function (data) {
	                return {
	                    results: $.map(data, function(obj) {
	                        return { id: obj.id, text:obj.name};
	                    })
	                };
	            }
	        }
	 	});
	$("#guestsToAvoid").select2({
	 	  ajax:{
	            url: "/eventplannerJava/eventplanner/guestservice/guests/"+$.urlParam("id")+"/gueststoavoid",
	            dataType: 'json',
	            type: 'GET',
	            cache:false,
	            processResults: function (data) {
	                return {
	                    results: $.map(data, function(obj) {
	                        return { id: obj.id, text:obj.name};
	                    })
	                };
	            }
	        }
	 	});
	// Get the basic guest attributes out of the database and add their values to the fields
	 $.ajax({
	    url: "/eventplannerJava/eventplanner/guestservice/guests/"+$.urlParam("id"),
	    type: 'GET',
	    datatype: 'json',
	    contentType: "application/json",
	    statusCode: {
	    200: function(response) {
			$('#name').val(response.name);
			$('#relationshipDescriptor').val(response.relationshipDescriptor);
	    }}
	  });
	
	$("#updatebtn").on('click',function (e){
		var guestName =$('#name').val();
		var note = $('#relationshipDescriptor').val();
		
		 // Post the update to dthe database.
		$.ajax( { 
			url:"/eventplannerJava/eventplanner/guestservice/guests/"+$.urlParam("id"),
			type: "PUT",
			dataType: "json",
			contentType: "application/json",
			data: '{'+  
				'"name" : "'+guestName+'",'+
				'"relationshipDescriptor" :"'+ note+'"'+
			"}",
			statusCode: {
				200: function(response) {				  
					  window.location.assign("guestList.html?id="+$.urlParam('event')+"&anthony=anthony");
			  		},
			  	401:function( response ) {
	  	    			$('#page-message').html("You must Login first");
	  	    			},
	  	      	405:function( response ) {
	  		  	    	$('#page-message').html("Access to the page forbiden");
	  		  	    	},
	
			  	406: function(response) {
			  		var errors = response.responseJSON;
			  		$(".error").html("*");
			  		$.each(errors, function (i, message) {
			  			$("#"+message.attributeName+"Err").html(message.message);
			  			console.log("Error "+message.attributeName +" "+message.message)
	    	        		});
			  		$("#page-message").html("Fix errors and click Save");
			  		},
			  	
				404 : function(jqXHR, textStatus, errorThrown) {
					$("#page-message").html("Error:"+textStatus);
					console.log(errorThrown);
		  	        console.log("error " + textStatus);
		  	        console.log("incoming Text " + jqXHR.responseText);
		  	    	}
		  	}
		
			});
		
   });
	
	$("#sitwithbtn").on('click',function (e){
		$.ajax( { 
			url:"/eventplannerJava/eventplanner/guestservice/guests/"+$.urlParam("id")+"/gueststositwith/"+$("#guestselection").val(),
			type: "PUT",
			dataType: "json",
			contentType: "application/json",
			statusCode: {
				200: function() {
					alert("Guest to sit with added.");
				}
			}
		});
	});
  });
		    
</script>
       
    </head>
<body class="pageBody">

  <div class="container">
<div class="row">
<nav>
    <ul class="nav nav-pills" >
      <li role="presentation"><a href="eventsList.html">Events</a></li>
  <li role="presentation"><a href="customerList.html">Customer</a></li>
  <li role="presentation"><a href="userList.html">Users</a></li>
  <li class="logouttab pull-right" role="presentation"><a onclick ="confirmLogout();" href="#">Logout</a></li>
    </ul>
  </nav>
</div>
    
    <div class="text-center">
     <h1>Update Guest</h1>
    </div>
    
   <div class="row">
   <div class="col-sm-4">
 <form>
  <div class="form-group text-left">
    <label for="InputName">Guest Name</label>
    <input type="text" class="form-control" placeholder="Name" id="name">
  </div>
  <div class="form-group">
    <label for="realationshipDescriptor">Note</label>
    <input type="text" class="form-control" id ="relationshipDescriptor">
  </div>
  <div class="form-group">
    <label class="control-label requiredField" for = "guestselection">
     Other Guest
      <span class ="asteriskField">*</span>
      </label>
      <select class=" select form-control" id="guestselection" name ="guestselection" data-placeholder="Select an option">
    </select>
     </div>
       </form>
     </div>
    <div class="col-sm-2 col-sm-offset">
    <div class="buttonShould">
      <button id="sitwithbtn" type="button" class="btn btn-primary">Should Sit With</button>
       <br><br>
      <button id="avoidbtn" type="button" class="btn btn-primary">Should Avoid</button>
     </div>
  </div>
  <div class="col-sm-3"> 
    <div class="groupList">
     		<form>
			     <div class="form-group">
				    <label class="control-label requiredField" for = "guestsToAvoid">
				     Guests (S)He Must Avoid
				      <span class ="asteriskField">*</span>
				      </label>
				      <select class=" select form-control" id="guestsToAvoid" name ="guestsToAvoid">
				    </select>
			     </div>
			     <br><br><br><br><br><br>
			     <button id="removeavoidbtn" type="button" class="btn-remove btn btn-primary">Remove</button>	
     		</form>
    </div>
   </div>
   <div class="col-sm-3">
          <form>
			     <div class="form-group">
				    <label class="control-label requiredField" for = "guestsToSitWith">
				     Guests S(H)e Must Sit With
				      <span class ="asteriskField">*</span>
				      </label>
				      <select class=" select form-control" id="guestsToSitWith" name ="guestsToSitWith">
				    </select>
			     </div>
			     <br><br><br><br><br><br>
			     <button id="removesitwithbtn" type="button" class="btn-remove btn btn-primary">Remove</button>	
     	</form>
   </div>  
    </div>
     <div class="footer-buttons">
     <br><br><br>
     <div class="row">
     <div class="col-sm-3 col-sm-offset-3"> 
          <div class="form-group">
       <div>
       <button class="btn btn-primary " name="submit" type="submit" onclick="generateTableMarker()">Generate Table Marker</button>
    </div>
    </div>
    </div>
    <div class="col-sm-1">
    <div class="form-group">
        <div>
        
<button id="updatebtn" class="btn btn-primary" name="submit" type="submit">
Update
</button>
        
</div>
</div>
</div>
<div class="col-sm-1">
<div class="form-group">
<div>
<button class="btn btn-primary " name="submit" onclick="backToGuestList()">
        Cancel
</button>
  </div>
 </div>
 </div>
</div>
</div>
</div>
</body>
</html>
