<!DOCTYPE html>
<html lang="en">
<head>
  <title>Event Form</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <!--Font Awesome (added because you use icons in your prepend/append)-->
	<link rel="stylesheet" href="https://formden.com/static/cdn/font-awesome/4.4.0/css/font-awesome.min.css" />
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body class="pageBody">

<div class="container">
<div class=row>
<ul class="nav nav-pills" >
  <li role="presentation"><a href="eventsList.html">Events</a></li>
  <li role="presentation"><a href="customerList.html">Customers</a></li>
  <li role="presentation"><a href="userList.html">Users</a></li>
  <li class="logouttab pull-right" role="presentation"><a onclick ="confirmLogout();" href="#">Logout</a></li>
</ul>
</div>
<div class="formrow">
  <h3>Event Form</h3> 
   <h4>Event Information</h4>
  <div class="row">
  	  <form method="post">
    <div class="col-sm-6"> 
     <div class="form-group ">
      <label class="control-label requiredField" for="eventName">
       Event Name
       <span class="asteriskField">
        *
       </span>
      </label>
      <input class="form-control" id="eventName" name="eventName" type="text"/>
     </div>
       <div class="form-group ">
      <label class="control-label requiredField" for="date">
       Date
       <span class="asteriskField">
        *
       </span>
      </label>
      <div class="input-group">
       <div class="input-group-addon">
        <i class="fa fa-calendar-check-o">
        </i>
       </div>
       <input class="form-control" id="date" name="date" placeholder="MM/DD/YYYY" type="text"/>
      </div>
     </div>
     <div class="form-group ">
      <label class="control-label requiredField" for="venueloc">
       Venue
       <span class="asteriskField">
        *
       </span>
      </label>
      <input class="form-control" id="venueloc" name="venueloc" type="text"/>
     </div>
     <div class="form-group ">
      <label class="control-label requiredField" for="emptySeats">
       Percentage of Empty Seats
       <span class="asteriskField">
        *
       </span>
      </label>
      <input class="form-control" id="emptySeats" name="emptySeats" type="text"/>
     </div>

     <div class="form-group ">
      <label class="control-label requiredField" for="sizeselection">
       Table Size
       <span class="asteriskField">
        *
       </span>
      </label>
      <select class="form-control searchableselect" id="sizeselection" name="sizeselection" data-placeholder="Select an option">
      	<option value="4">4</option>
       <option value="6">6</option>
       <option value="8">8</option>
      </select>
     </div>
    </div>
    <div class="col-sm-6">
    <div class="form-group ">
      <label class="control-label requiredField" for="shapeselection">
       Table Shape
       <span class="asteriskField">
        *
       </span>
      </label>
      <select class="form-control searchableselect" id="shapeselection" name="select2" data-placeholder="Select an option">
      	<option value="Square">Square</option>
       <option value="Rectangular">Rectangular</option>
       <option value="Circular">Circular</option>
      </select>
     </div>
 	<div class="form-group ">
      <label class="control-label requiredField" for="status">
       Event Status
       <span class="asteriskField">
        *
       </span>
      </label>
      <select class=" form-control searchableselect" id="status" name="status" data-placeholder="Select an option">
      <option value="Open">Open</option>
       <option value="Closed">Closed</option>
      </select>
     </div>
    <h4>Customer Information</h4>
     <div class="form-group custSelectOption">
      <label class="control-label requiredField" for = "customerselection">
      Customer Name
      <span class ="asteriskField">*</span>
      </label>
      <select class="form-control searchableselect" id="customerselection" name ="customerselection" data-placeholder="Select an option"
      ></select>
     </div>
     <h4>Office Information</h4>
     <div class="form-group epSelectOption">
      <label class="control-label requiredField" for="eventPlannerSelection">
       Event Planner
       <span class="asteriskField">
        *
       </span>
      </label>
      <select class="form-control searchableselect" id="eventPlannerSelection" name="eventPlannerSelection" data-placeholder="Select an option"></select>
     </div>
     </div>
    </form>
    </div>
     <div class="row">
    	<div class="col-md-12">
    	<div class="form-group ">
      <label class="control-label requiredField" for="eventMenu">
       Event Menu
       <span class="asteriskField">
        *
       </span>
      </label>
      <input class="form-control" id="eventMenu" name="eventMenu" type="text"/>
     </div>
    	</div>
    </div>
    </div>
    <div class="pageFooter">
    <br><br>
    <div class ="row">
   <div class="col-md-3"><div class="form-group">
      <div>
       <input id="importfile" class="btn btn-primary " name="submit" type="file">
       <button id="importbtn" class="btn btn-primary " name="submit" type="submit">
         Save and Import Guests
       </button>
      </div>
     </div>
    </div>
   <div class="col-md-3"><div class="form-group">
      <div>
       <button id="viewguestsbtn" class="btn btn-primary " name="submit" type="submit">
        View Guests
       </button>
      </div>
     </div>
    </div>
  <div class="col-md-3"><div class="form-group">
      <div>
       <button id="generateassignmentsbtn" class="btn btn-primary " name="submit" type="submit">
        Generate Seating Assignments
       </button>
      </div>
     </div></div>
   <div class="col-md-3"><div class="form-group">
      <div>
       <button id="viewassignmentsbtn" class="btn btn-primary " name="submit" type="submit">
        View Seating Assignments
       </button>
      </div>
     </div>
   </div>
    </div>
   
    <div class=row>
    <div class="col-md-3"><div class="form-group">
      <div>
       <button id="seatingreportsa_zbtn" class="btn btn-primary " name="submit" type="submit" onclick="generateSeatingReportAlpha()">
        Generate Seating Reports Alphabetically
       </button>
      </div>
     </div>
   </div>
   <div class="col-md-3"><div class="form-group">
      <div>
       <button id = "reportsbytablebtn" class="btn btn-primary " name="submit" type="submit" onclick="generateSeatingReportTables()">
        Generate Seating Reports By Table
       </button>
      </div>
     </div>
     </div>
   <div class="col-md-3"><div class="form-group">
      <div>
       <button id = "generatemarkersbtn" class="btn btn-primary" name="submit" type="submit" onclick="generateTableMarkers()">
        Generate Table Markers
       </button>
      </div>
     </div></div>
     	<div class="col-md-1"><div class="form-group" id="savebtn">
      <div>
       <button class="btn btn-primary " name="submit" type="submit" onclick="save();">
        Save
       </button>
      </div>
     </div></div>
        <div class="col-md-1"><div class="form-group">
      <div>
       <button id="cancelbtn" class="btn btn-primary" name="submit" type="submit" onclick="cancel();">
        Cancel
       </button>
      </div>
     </div></div>
    </div>
    <br>
    </div>
</div> 
<br><br><br><br><br>
<script>
	function getCurrentUser() {
		$.ajax({
		    url: "/eventplannerJava/eventplanner/userservice/users/current",
		    type: 'GET',
		    datatype: 'json',
		    statusCode: {
		    200: function( response ) {
		
				//$('#userWelcome').html("Welcome, "+response.firstName+" "+response.lastName);
		    },
		    401:function( response ) {
		    		alert("You must login first");}
		    },
		    error: function(jqXHR, textStatus, errorThrown) {
	  	        console.log("error " + textStatus);
	  	        console.log("incoming Text " + jqXHR.responseText);},    
			beforeSend: setHeader
		});   	
	}
	function getCookie(cname) {
	    var name = cname + "=";
	    var decodedCookie = decodeURIComponent(document.cookie);
	    var ca = decodedCookie.split(';');
	    for(var i = 0; i <ca.length; i++) {
	        var c = ca[i];
	        while (c.charAt(0) == ' ') {
	            c = c.substring(1);
	        }
	        if (c.indexOf(name) == 0) {
	            return c.substring(name.length, c.length);
	        }
	    }
	    return "";
	}
	
	function setHeader(xhr) {
		  token = getCookie("token");
		  xhr.setRequestHeader('Authorization', 'Bearer '+token );		  
	}
	$.urlParam = function(name){
	    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
	    if (results==null){
	       return null;
	    }
	    else{
	       return results[1] || 0;
	    }
	}
	  function confirmLogout(){
	        agree = confirm("Do you want to logout?");
	         if(agree){
	     		window.location.assign("Logout.html");
	     	 }
	  }
    $(document).ready(function(){
    	getCurrentUser();
    	$(".searchableselect").select2();
    	$("#customerselection").prop("disabled", true);
    	var date_input=$('input[name="date"]'); //our date input has the name "date"
        var container=$('.bootstrap-iso form').length>0 ? $('.bootstrap-iso form').parent() : "body";
        date_input.datepicker({
            format: 'mm/dd/yyyy',
            container: container,
            todayHighlight: true,
            autoclose: true,
        });
        $("#customerselection").select2({
   	 	  ajax:{
  	            url: '/eventplannerJava/eventplanner/customerservice/customers',
  	            dataType: 'json',
  	            type: 'GET',
  	            processResults: function (data) {
  	            	customers=data;
  	                return {
  	                    results: $.map(data, function(obj) {
  	                        return { id: obj.id, text: (obj.name+"_"+obj.id)};
  	                    })
  	                };
  	            }
  	        }
   	 	});
   	 $("#eventPlannerSelection").select2({
  	 	  ajax:{
  	            url: '/eventplannerJava/eventplanner/userservice/users',
  	            dataType: 'json',
  	            type: 'GET',
  	            processResults: function (data) {
  	            	//alert(data[2].name);
  	                return {
  	                    results: $.map(data, function(obj) {
  	                        return { id: obj.id, text: (obj.name+"_"+obj.id)};
  	                    })
  	                };
  	            },
	    		beforeSend: setHeader
  	        }
  	 	});

    	//Populate the form with the data for the selected event
        $.getJSON("/eventplannerJava/eventplanner/eventservice/events/"+$.urlParam("id"))
    	.done(function(response){
    		$('#eventName').val(response.name);
    		$('#eventPlannerSelection').empty().append('<option>'+response.assignedUser.name+'_'+response.assignedUser.id+'</option>');    

    		$('#customerselection').empty().append('<option>'+response.customer.name+'_'+response.customer.id+'</option>');  
    		$('#date').val(response.date);
    		$("#status").val(response.eventStatus);
    		$('#venueloc').val(response.location);
    		$('#eventMenu').val(response.menu);
    		$('#emptySeats').val(response.percentSeatsEmpty);
    		
    		//I must add to this table size and shape, 
    	})
    	.fail(function(jqXHR, textStatus, errorThrown) {
	    console.log("error " + textStatus);
	    console.log("incoming Text " + jqXHR.responseText);
	    });
    });
    function save (){
		//e.preventDefault;
		var eventName = $('#eventName').val();
    	var selectedEventPlanner = $('#eventPlannerSelection').val();  
    	var selectedCustomer= $('#customerselection').val(); 
    	var eventDate= $('#date').val();
    	var eventStatus= $('#status').val();
    	var eventLocation= $('#venueloc').val();
    	var eventMenu= $('#eventMenu').val();
    	var emptySeats= $('#emptySeats').val();
    	var selectedCustomerId = (selectedCustomer.split('_'))[1];
    	var seatsPerTable = $('#sizeselection').val();
		
    	$.when($.ajax("/eventplannerJava/eventplanner/userservice/users/"+selectedEventPlanner,{type:"GET",
    		dataType:"json",
    		beforeSend: setHeader,
    		contentType:"application/json"}), 
    			$.ajax("/eventplannerJava/eventplanner/customerservice/customers/"+selectedCustomerId))
    	  .then(function(userResponse, customerResponse){
			var user = userResponse[0];
			var customer = customerResponse[0];
			var jsonstr = {
					"assignedUser":{
						"company":{
							"id":1,
							"name":"Eagles Event Planning"
						},
						"id":user.id,
						"isActive":true,
						"name":user.name,
						"okToDelete":true,
						"password":user.password,
						"roleAssignments":[{"role":user.roleAssignments[0].role}],
						"username":user.username
					},
					"customer":{
						"email":customer.email,
						"id":customer.id,
						"name":customer.name,
						"okToDelete":true,
						"phoneNumber":customer.phoneNumber
					},
					"date":Number(eventDate),
					"eventStatus":eventStatus,
					"location":eventLocation,
					"menu":eventMenu,
					"name":eventName,
					"okToDelete":true,
					"percentSeatsEmpty":parseFloat(emptySeats),
					"seatsPerTable":seatsPerTable,
					"totalSeats":100	
			};
			alert(JSON.stringify(jsonstr));
			$.ajax( {
				url:"/eventplannerJava/eventplanner/eventservice/events/"+$.urlParam("id"),
				type: "PUT",
				dataType: "json",
	    		beforeSend: setHeader,
				contentType: "application/json",
				data: JSON.stringify(jsonstr),	
				success: (function(data) {
		 			  console.log("Update success ");
		 			  window.location.assign("eventsList.html");
		 		}),
		 		fail: (function(jqXHR, textStatus, errorThrown) {
		 	 	      console.log("Update error " + textStatus);
		 	 	      console.log("incoming Text " + jqXHR.responseText);
		 		})
				});
    	  });
	}
    function cancel(){
    	window.location.assign("eventsList.html");
    }
    $("#generatemarkersbtn").click(function(){
    	window.location.assign("#");
    });
    $("#importbtn").click(function(){
    	//open the file picker
    });
	$("#viewguestsbtn").click(function(){
	 	window.location.assign("guestList.html?id="+$.urlParam("id")+"&like=like");
	});
	 $("#generateassignmentsbtn").click(function(){
	 	window.location.assign("#");
	 });
	 $("#viewassignmentsbtn").click(function(){
	 	window.location.assign("updateAssignments.html?id="+$.urlParam("id")+"&like=like");
	 });
	 
	 // Unneeded. The logic is handled by the vanilla JS functions below
	 $("#seatingreportsa_zbtn").click(function(){
	 	window.location.assign("#");
	 });
	 $("#reportsbytablebtn").click(function(){
	 	window.location.assign("#")
	 });
	 $("#generatemarkersbtn").click(function(){
		 window.location.assign("#");	
	 });
	 
	 function generateTableMarkers() {
		    var req = new XMLHttpRequest();
			 req.open("GET", "/eventplannerJava/eventplanner/reportservice/events/"+$.urlParam("id")+"/tablemarkers", true);
			 req.responseType = "blob";
			 req.onload = function (event) {
				 var blob = req.response;
				 console.log(blob.size);
				 var link = document.createElement('a');
				 link.href = window.URL.createObjectURL(blob);
				 link.download = "TableMarkers_" + new Date() + ".pdf";
				 link.click();
			 };
			 req.send();
	 }
	    
    function generateSeatingReportTables() {
    	var req = new XMLHttpRequest();
		 req.open("GET", "/eventplannerJava/eventplanner/reportservice/events/"+$.urlParam("id")+"/tablenumberseatingreport", true);
		 req.responseType = "blob";
		 req.onload = function (event) {
			 var blob = req.response;
			 console.log(blob.size);
			 var link = document.createElement('a');
			 link.href = window.URL.createObjectURL(blob);
			 link.download = "SeatRepByTable_" + new Date() + ".pdf";
			 link.click();
		 };
		 req.send();
    }
    
    function generateSeatingReportAlpha() {
    	var req = new XMLHttpRequest();
		 req.open("GET", "/eventplannerJava/eventplanner/reportservice/events/"+$.urlParam("id")+"/alphabeticalseatingreport", true);
		 req.responseType = "blob";
		 req.onload = function (event) {
			 var blob = req.response;
			 console.log(blob.size);
			 var link = document.createElement('a');
			 link.href = window.URL.createObjectURL(blob);
			 link.download = "SeatRepByTable_" + new Date() + ".pdf";
			 link.click();
		 };
		 req.send();
    }
    
    $('#importbtn').on('click', function() {
       
    	// Get file name
    	var fileList = document.getElementById('importfile').files;
    	console.log(fileList[0]);
    	var data = new FormData();
    	data.append("file", fileList[0]);
    	
    	$.ajax({
            // Your server script to process the upload
            url: "/eventplannerJava/eventplanner/eventservice/events/"+$.urlParam("id")+"/importguestlist/",
            type: "POST",

            // Form data
            data: data,

            // Tell jQuery not to process data or worry about content-type
            // You *must* include these options!
            cache: false,
            contentType: false,
            processData: false,
            success: function(response) {
            	alert(response);
            },
        });
    });
    
</script>
</body>
</html>
