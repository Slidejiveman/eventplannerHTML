<!DOCTYPE HTML> 
<html>
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>

</head>
<body> 
<script>
function confirmLogout(){
    agree = confirm("Do you want to logout?");
     if(agree){
 		window.location.assign("Logout.html");
 	}
}

function getCurrentUser() {
	$.ajax({
	    url: "/eventplannerJava/eventplanner/userservice/users/current",
	    type: 'GET',
	    datatype: 'json',
	    statusCode: {
	    200: function( response ) {
	
			$('#userWelcome').html("Welcome, "+response.firstName+" "+response.lastName);
	    },
	    401:function( response ) {
	    		$('#student-list-table').html("You must Login first");}
	    },
	    
	    error: function(jqXHR, textStatus, errorThrown) {
  	        console.log("error " + textStatus);
  	        console.log("incoming Text " + jqXHR.responseText);},
	    beforeSend: setHeader       
	  });   	
}
function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

function setHeader(xhr) {
	  token = getCookie("token");
	  xhr.setRequestHeader('Authorization', 'Bearer '+token );		  
}

$(document).ready(function() {

	getCurrentUser();
	$("#userForm").submit(function (e){
		
		var name = $('#name').val();
		var username= $('#username').val();
		var password = $('#password').val();		
		var role = $('#role').val();
		var jsonData = 
					'{'+  
					'"name" :"'+name+'",'+					
					'"username" : "'+username+'",'+
					'"password" : "'+password+'",'+
					'"roleAssignments" : [ {"role": "'+role+'" } ] }';
				
		$.ajax( { 
			url:"/eventplannerJava/eventplanner/userservice/users/",
			type: "POST",
			dataType: "json",
			contentType: "application/json",
			data: jsonData,  
		statusCode: {
			200: function(response) {
				  $("#page-message").html("Record Added");
				  window.location.assign("userList.html");
		  		},
		  	401:function( response ) {
	    			$('#page-messge').html("You must Login first");
	    			},
		  	405:function( response ) {
	  	    		$('#page-messge').html("Access to the page forbiden");
	  	    		},
		  	406: function(response) {
		  		var errors = response.responseJSON;
		  		$(".error").html("*");
		  		$.each(errors, function (i, message) {
		  			$("#"+message.attributeName+"Err").html(message.message);
		  			console.log("Error "+message.attributeName +" "+message.message)
    	        		});
		  		$("#page-message").html("Fix errors and click Save");
		  		},
		  					  	
			404: function(jqXHR, textStatus, errorThrown) {
				$("#page-message").html("Error:"+textStatus);
				console.log(errorThrown);
	  	        console.log("error " + textStatus);
	  	        console.log("incoming Text " + jqXHR.responseText);
	  	      }
			},
			beforeSend: setHeader
		});
		e.preventDefault();
});
});
</script>
<div>
<ul class="nav">
<li><a href="eventList.html">Event</a></li>
<li><a href="customerList.html">Customer</a></li>
<li><a href="userList.html">Users</a></li>
<li class="logouttab pull-right" role="presentation"><a onclick ="confirmLogout();" href="#">Logout</a></li>
</ul>
</div>
<div id="userWelcome"> </div>
<h2>User Add</h2>
<p id ='debug'></p>
<div class ='block-center'>
<p><span id="page-message">Enter fields and click Save</span></p>
<p><span class="error-head">* required field.</span></p>
<form id="userForm" method="post"> 
   Name: <input type="text" id="name">
   <span id="nameErr" class="error">* </span>
   <br><br>
   Username: <input type="text" id="username">
   <span id ="userNameErr" class="error">* </span>
   <br><br>
   Password: <input type="text" id="password">
   <span id="passwordErr" class="error">* </span>
   <br><br>
   Role:<select id="role">
  	<option value="Administrator">Administrator</option>
 	<option value="Standard">Standard</option>
   </select>
	<br><br>
   <input type="submit" name="Add" value="Add"> 
</form>
<form action="userList.html" method ="get">
<button type="submit" >Cancel</button>
</form>

</div>
</body>
</html>

